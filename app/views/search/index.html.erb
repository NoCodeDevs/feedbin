<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5">
  <title><%= @query.present? ? "Search: #{@query}" : @category.present? ? @category : "Search" %> - The Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Newsreader:opsz,wght@6..72,400;6..72,500;6..72,600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000000;
      --surface: #0a0a0a;
      --surface-2: #141414;
      --surface-3: #1a1a1a;
      --text: #ffffff;
      --text-2: #e5e5e5;
      --text-3: #a3a3a3;
      --text-4: #737373;
      --accent: #7c3aed;
      --accent-2: #8b5cf6;
      --border: #262626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      overflow-x: hidden;
      max-width: 100vw;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .logo {
      font-family: 'Newsreader', serif;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      text-decoration: none;
    }

    .header-nav {
      display: flex;
      gap: 4px;
    }

    .header-nav-link {
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-3);
      text-decoration: none;
      transition: all 0.15s;
    }

    .header-nav-link:hover { color: var(--text); background: var(--surface-2); }
    .header-nav-link.active { color: var(--accent-2); background: rgba(124, 58, 237, 0.15); }

    .search-form {
      flex: 1;
      max-width: 500px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 14px center;
      background-size: 18px;
    }

    .search-input::placeholder { color: var(--text-4); }
    .search-input:focus { outline: none; border-color: var(--accent); }

    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }

    .page-header {
      display: flex;
      align-items: baseline;
      gap: 16px;
      margin-bottom: 16px;
    }

    .page-title {
      font-family: 'Newsreader', serif;
      font-size: 28px;
      font-weight: 500;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-4);
    }

    .categories {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .category-pill {
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-3);
      text-decoration: none;
      background: var(--surface-2);
      border: 1px solid var(--border);
      transition: all 0.2s;
      cursor: pointer;
      font-family: inherit;
    }

    .category-pill:hover { color: var(--text); background: var(--surface-3); }
    .category-pill.active { color: white; background: var(--accent); border-color: var(--accent); }
    .category-hidden { display: none; }
    .categories.expanded .category-hidden { display: inline-flex; }
    .categories.expanded .category-more { display: none; }
    .category-more { color: var(--accent-2); border-color: var(--accent); }

    /* Mobile category dropdown */
    .categories-mobile { display: none; margin-bottom: 20px; }
    .category-select {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      font-family: inherit;
      font-weight: 500;
      color: var(--text);
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      cursor: pointer;
    }
    .category-select:focus { outline: none; border-color: var(--accent); }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .card {
      position: relative;
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border-radius: 16px;
      overflow: hidden;
      color: inherit;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 1px solid var(--border);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }

    .card-link {
      display: flex;
      flex-direction: column;
      flex: 1;
      text-decoration: none;
      color: inherit;
    }

    .card-image {
      position: relative;
      aspect-ratio: 16/10;
      overflow: hidden;
      background: var(--surface-2);
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s;
    }

    .card:hover .card-image img { transform: scale(1.08); }

    .card-image .badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 5px 12px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-2);
    }

    .card-body {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card-category {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-2);
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 17px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card:hover .card-title { color: var(--accent-2); }

    .card-excerpt {
      font-size: 14px;
      color: var(--text-3);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      flex: 1;
    }

    .card-meta {
      font-size: 12px;
      color: var(--text-4);
      margin-top: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-state h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: var(--text-3);
    }

    .search-layout {
      display: flex;
      max-width: 1600px;
      margin: 0 auto;
      min-height: calc(100vh - 65px);
    }
    .sources-sidebar {
      width: 260px;
      flex-shrink: 0;
      padding: 24px 0 24px 24px;
      border-right: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 65px;
      align-self: flex-start;
      max-height: calc(100vh - 65px);
      overflow-y: auto;
    }
    .sources-sidebar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-4);
      margin-bottom: 12px;
      padding: 0 12px;
    }
    .sources-nav {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .source-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      color: var(--text-2);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.15s, color 0.15s;
    }
    .source-item:hover {
      background: var(--surface-2);
      color: var(--text);
    }
    .source-item.active {
      background: rgba(124, 58, 237, 0.2);
      color: var(--accent-2);
    }
    .source-name {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .source-count {
      flex-shrink: 0;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-4);
    }
    .source-item.active .source-count { color: var(--accent-2); }
    .search-main { flex: 1; min-width: 0; }

    /* Trending Sidebar */
    .trending-sidebar {
      width: 260px;
      flex-shrink: 0;
      padding: 20px 16px;
      border-right: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 65px;
      align-self: flex-start;
      max-height: calc(100vh - 65px);
      overflow-y: auto;
    }
    .trending-sidebar-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-4);
      margin-bottom: 12px;
      padding: 0 8px;
    }
    .trending-nav {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .trending-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 8px;
      color: var(--text-2);
      text-decoration: none;
      transition: all 0.15s;
    }
    .trending-item:hover { background: var(--surface-2); color: var(--text); }
    .trending-item.active { background: rgba(124, 58, 237, 0.12); color: var(--accent-2); }
    .trending-emoji { font-size: 18px; width: 24px; text-align: center; flex-shrink: 0; }
    .trending-content { flex: 1; min-width: 0; }
    .trending-name {
      font-size: 13px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.3;
    }
    .trending-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }
    .trending-count {
      font-size: 11px;
      color: var(--text-4);
      font-weight: 500;
    }
    .trending-sparkline {
      color: var(--accent-2);
      opacity: 0.7;
      height: 16px;
      display: flex;
      align-items: center;
    }
    .trending-sparkline svg { width: 50px; height: 14px; }
    .trending-badge {
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      flex-shrink: 0;
    }
    .trending-badge.rising { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .trending-badge.falling { background: rgba(239, 68, 68, 0.12); color: #f87171; }
    .trending-empty { padding: 12px 8px; color: var(--text-4); font-size: 12px; }
    .trending-divider { height: 1px; background: var(--border); margin: 16px 0; }

    /* Crawl Timing */
    .crawl-timing {
      display: flex;
      gap: 20px;
      padding: 10px 12px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .timing-item { display: flex; flex-direction: column; gap: 1px; }
    .timing-label {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-4);
    }
    .timing-value {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-3);
    }

    /* Topic Analysis Panel */
    .topic-analysis-panel {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .analysis-loading {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--accent-2);
      font-size: 14px;
      font-weight: 500;
    }
    .analysis-loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent-2);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .analysis-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .analysis-icon {
      width: 28px;
      height: 28px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    .analysis-title {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--accent-2);
    }
    .analysis-close {
      background: none;
      border: none;
      color: var(--text-4);
      cursor: pointer;
      font-size: 20px;
      padding: 4px 8px;
      line-height: 1;
    }
    .analysis-close:hover { color: var(--text); }
    .analysis-summary {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-2);
      margin-bottom: 24px;
    }
    .analysis-perspectives {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .perspective-card {
      padding: 14px;
      background: var(--surface-2);
      border-radius: 10px;
    }
    .perspective-source {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }
    .perspective-angle {
      font-size: 13px;
      color: var(--text-3);
      line-height: 1.5;
    }
    .perspective-tone {
      display: inline-block;
      margin-top: 8px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .tone-neutral { background: var(--surface-3); color: var(--text-3); }
    .tone-positive { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .tone-negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .tone-critical { background: rgba(249, 115, 22, 0.2); color: #f97316; }
    .analysis-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(124, 58, 237, 0.2);
    }
    .analysis-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-4);
      margin-bottom: 8px;
    }
    .analysis-section-text {
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.6;
    }
    .analysis-empty {
      color: var(--text-3);
      font-size: 14px;
    }
    .analysis-clusters {
      margin-bottom: 20px;
    }
    .cluster-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--surface-2);
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-3);
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .takeaways-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .takeaways-list li {
      position: relative;
      padding-left: 20px;
      margin-bottom: 10px;
      font-size: 14px;
      color: var(--text-2);
      line-height: 1.5;
    }
    .takeaways-list li::before {
      content: "→";
      position: absolute;
      left: 0;
      color: var(--accent-2);
    }
    .key-articles {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .key-article-link {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 10px 12px;
      background: var(--surface-2);
      border-radius: 8px;
      text-decoration: none;
      transition: background 0.15s;
    }
    .key-article-link:hover { background: var(--surface-3); }
    .key-article-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      line-height: 1.4;
    }
    .key-article-source {
      font-size: 11px;
      color: var(--accent-2);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .analysis-meta {
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-4);
    }
    /* AI Button on Cards */
    .card-ai-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      background: rgba(124, 58, 237, 0.9);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, background 0.15s;
    }
    .card:hover .card-ai-btn { opacity: 1; }
    .card-ai-btn:hover { background: var(--accent-2); }
    /* Article Summary Modal */
    .article-summary-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }
    .article-summary-modal.open { display: flex; }
    .article-summary-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .article-summary-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }
    .article-summary-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }
    .article-summary-title {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
    }
    .article-summary-close {
      background: none;
      border: none;
      color: var(--text-4);
      cursor: pointer;
      font-size: 20px;
      padding: 0;
    }
    .article-summary-tldr {
      font-size: 15px;
      color: var(--text-2);
      line-height: 1.6;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(124, 58, 237, 0.1);
      border-radius: 8px;
    }
    .article-summary-insights h4 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-4);
      margin-bottom: 10px;
    }
    .article-summary-insights ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .article-summary-insights li {
      position: relative;
      padding-left: 16px;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-3);
    }
    .article-summary-insights li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--accent-2);
    }

    .header-timing {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-4);
      margin-left: auto;
      margin-right: 16px;
    }
    .header-timing .timing-label {
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 500;
    }
    .header-timing .timing-value {
      color: var(--text-3);
    }
    .header-timing .timing-sep {
      color: var(--border);
    }

    .add-feed-btn {
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-2);
      background: var(--surface-2);
      border: 1px solid var(--border);
      cursor: pointer;
      text-decoration: none;
      font-family: inherit;
    }
    .add-feed-btn:hover { background: var(--surface-3); color: var(--text); }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 440px;
      width: 90%;
    }
    .modal-box h3 { font-size: 18px; margin-bottom: 16px; }
    .modal-box input[type="url"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface-2);
      color: var(--text);
      font-size: 15px;
      margin-bottom: 12px;
    }
    .modal-box .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .modal-box .form-actions button { padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .modal-box .form-actions button[type="submit"] { background: var(--accent); color: white; border: none; }
    .modal-box .form-actions button[type="button"] { background: var(--surface-2); color: var(--text-2); border: 1px solid var(--border); }
    .modal-box .feed-request-message { margin-top: 14px; font-size: 14px; min-height: 20px; }
    .modal-box .feed-request-message.success { color: var(--accent-2); }
    .modal-box .feed-request-message.error { color: #f87171; }

    .day-section { margin-bottom: 40px; }
    .day-heading {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-4);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .infinite-sentinel {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-4);
      font-size: 14px;
    }
    .infinite-sentinel.loading { color: var(--accent-2); }
    .infinite-sentinel.done { display: none; }

    .ai-response {
      display: none;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .ai-response.visible { display: block; }
    .ai-response.loading { opacity: 0.7; }
    .ai-response-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .ai-response-icon {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .ai-response-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-2);
    }
    .ai-response-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text-4);
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .ai-response-close:hover { color: var(--text); }
    .ai-response-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-2);
    }
    .ai-response-text p { margin-bottom: 12px; }
    .ai-response-text p:last-child { margin-bottom: 0; }
    .ai-response-sources {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(124, 58, 237, 0.2);
    }
    .ai-response-sources-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-4);
      margin-bottom: 10px;
    }
    .ai-source-link {
      display: inline-block;
      padding: 6px 12px;
      background: var(--surface-2);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-2);
      text-decoration: none;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: background 0.15s;
    }
    .ai-source-link:hover { background: var(--surface-3); color: var(--text); }
    .ai-loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--accent-2);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1000px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
      .trending-sidebar { width: 220px; }
    }

    @media (max-width: 768px) {
      .search-layout { flex-direction: column; }
      .trending-sidebar {
        width: 100%;
        padding: 16px;
        border-right: none;
        border-bottom: 1px solid var(--border);
        position: static;
        max-height: none;
        overflow-y: visible;
      }
      .trending-nav {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 8px;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
      }
      .trending-item {
        flex-shrink: 0;
        padding: 8px 12px;
        background: var(--surface-2);
        border-radius: 20px;
      }
      .trending-meta { display: none; }
      .trending-badge { display: none; }
      .header-timing { display: none; }
      .categories {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
      }
      .category-pill { flex-shrink: 0; }
      .grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .topic-analysis-panel { margin-bottom: 24px; padding: 16px; }
      .analysis-perspectives { grid-template-columns: 1fr; }
    }

    @media (max-width: 600px) {
      .header-inner {
        padding: 12px 16px;
        gap: 12px;
      }
      .logo { font-size: 20px; flex-shrink: 0; }
      .header-nav { display: none; }
      .search-form {
        flex: 1;
        min-width: 0;
        max-width: none;
      }
      .search-input { padding: 12px 14px 12px 42px; font-size: 16px; } /* 16px prevents iOS zoom */
      .add-feed-btn { display: none; }
      .main { padding: 16px; }
      .grid { grid-template-columns: 1fr; gap: 20px; }
      .page-header { flex-direction: column; gap: 4px; margin-bottom: 16px; }
      .page-title { font-size: 24px; }
      .page-subtitle { font-size: 14px; }
      .card { border-radius: 16px; }
      .card-image { aspect-ratio: 16/9; }
      .card-body { padding: 16px; }
      .card-title { font-size: 17px; line-height: 1.3; }
      .card-excerpt { font-size: 14px; -webkit-line-clamp: 2; }
      .card-meta { font-size: 13px; margin-top: 10px; }
      .card-ai-btn { width: 36px; height: 36px; font-size: 11px; bottom: 10px; right: 10px; opacity: 1; }
      .categories-desktop { display: none !important; }
      .categories-mobile { display: block; }
      .trending-sidebar { padding: 12px 16px; }
      .trending-sidebar-title { font-size: 10px; margin-bottom: 10px; }
      .trending-item { padding: 8px 12px; gap: 8px; min-height: 44px; }
      .trending-emoji { font-size: 16px; width: 24px; }
      .trending-name { font-size: 14px; }
      .topic-analysis-panel { padding: 16px; border-radius: 16px; }
      .analysis-header { margin-bottom: 16px; }
      .analysis-title { font-size: 13px; }
      .analysis-summary { font-size: 15px; line-height: 1.6; margin-bottom: 20px; }
      .takeaways-list li { font-size: 14px; margin-bottom: 10px; }
      .key-article-link { padding: 12px; min-height: 44px; }
      .key-article-title { font-size: 14px; }
      .article-summary-box { padding: 20px; border-radius: 16px; max-height: 85vh; }
      .article-summary-title { font-size: 16px; }
      .article-summary-tldr { font-size: 15px; padding: 14px; }
      .day-heading { font-size: 13px; margin-bottom: 16px; }
    }

    @media (max-width: 400px) {
      .header-inner { padding: 10px 12px; gap: 8px; }
      .logo { font-size: 18px; }
      .search-input { padding: 8px 10px 8px 36px; font-size: 13px; background-size: 16px; background-position: 10px center; }
      .main { padding: 12px; }
      .page-title { font-size: 20px; }
      .card-body { padding: 12px; }
      .card-title { font-size: 14px; }
      .card-meta { font-size: 11px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">The Feed</a>
      <nav class="header-nav">
        <a href="/" class="header-nav-link active">Browse</a>
      </nav>
      <% if @crawl_timing %>
      <div class="header-timing">
        <span class="timing-label">Updated</span>
        <span class="timing-value"><%= @crawl_timing[:last_updated] ? time_ago_in_words(@crawl_timing[:last_updated]) : "—" %></span>
        <span class="timing-sep">·</span>
        <span class="timing-label">Next</span>
        <span class="timing-value"><%= @crawl_timing[:next_update_in] > 60 ? "#{(@crawl_timing[:next_update_in] / 60).round}m" : "soon" %></span>
      </div>
      <% end %>
      <form action="/search/smart_feed" method="get" class="search-form" id="ask-form">
        <input type="text" name="prompt" class="search-input" id="ask-input" value="<%= @query %>" placeholder="Ask anything about your feed..." autofocus>
      </form>
      <button type="button" class="add-feed-btn" id="add-feed-open">Add feed</button>
    </div>
  </header>

  <div class="modal-overlay" id="add-feed-modal">
    <div class="modal-box">
      <h3>Add a feed</h3>
      <p style="font-size: 14px; color: var(--text-3); margin-bottom: 14px;">Enter the feed URL (RSS or Atom). We'll validate it before adding.</p>
      <form id="add-feed-form">
        <input type="url" name="url" id="add-feed-url" placeholder="https://example.com/feed.xml" required>
        <div class="form-actions">
          <button type="button" id="add-feed-cancel">Cancel</button>
          <button type="submit">Add feed</button>
        </div>
        <div class="feed-request-message" id="add-feed-message"></div>
      </form>
    </div>
  </div>

  <div class="article-summary-modal" id="article-summary-modal">
    <div class="article-summary-box">
      <div class="article-summary-header">
        <div class="article-summary-icon">AI</div>
        <h3 class="article-summary-title" id="summary-title">Loading...</h3>
        <button type="button" class="article-summary-close" onclick="closeSummaryModal()">&times;</button>
      </div>
      <div id="summary-content">
        <div class="analysis-loading" style="justify-content: center;">
          <div class="spinner"></div>
          <span>Analyzing article...</span>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      var openBtn = document.getElementById('add-feed-open');
      var modal = document.getElementById('add-feed-modal');
      var cancelBtn = document.getElementById('add-feed-cancel');
      var form = document.getElementById('add-feed-form');
      var messageEl = document.getElementById('add-feed-message');
      var urlInput = document.getElementById('add-feed-url');
      function openModal() { modal.classList.add('open'); urlInput.focus(); }
      function closeModal() { modal.classList.remove('open'); messageEl.textContent = ''; }
      openBtn.addEventListener('click', openModal);
      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        messageEl.textContent = 'Checking...';
        messageEl.className = 'feed-request-message';
        fetch('/feed_requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' },
          body: JSON.stringify({ url: urlInput.value.trim() })
        }).then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); })
          .then(function(result) {
            if (result.data.error) {
              messageEl.textContent = result.data.error;
              messageEl.className = 'feed-request-message error';
            } else {
              messageEl.textContent = result.data.message || 'Feed added.';
              messageEl.className = 'feed-request-message success';
              urlInput.value = '';
              setTimeout(closeModal, 2000);
            }
          })
          .catch(function() {
            messageEl.textContent = 'Something went wrong. Try again.';
            messageEl.className = 'feed-request-message error';
          });
      });
    })();
  </script>
  <script>
    (function() {
      var form = document.getElementById('ask-form');
      var input = document.getElementById('ask-input');
      var responseEl = document.getElementById('ai-response');
      var answerEl = document.getElementById('ai-answer');
      var sourcesEl = document.getElementById('ai-sources');
      var sourcesListEl = document.getElementById('ai-sources-list');
      var closeBtn = document.getElementById('ai-close');

      form.addEventListener('submit', function(e) {
        var query = input.value.trim();
        if (!query) return;

        // Prevent default form submission - we'll handle it with JS
        e.preventDefault();

        // Update URL
        var encodedQuery = encodeURIComponent(query);
        window.history.pushState({}, '', '/?q=' + encodedQuery);

        // Show the topic analysis panel with loading
        var panel = document.getElementById('topic-analysis');
        var loading = panel.querySelector('.analysis-loading');
        var content = panel.querySelector('.analysis-content');
        panel.style.display = 'block';
        loading.style.display = 'flex';
        content.innerHTML = '';

        // Fetch AI analysis
        fetch('/search/analyze_topic?q=' + encodedQuery)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            loading.style.display = 'none';
            content.innerHTML = renderTopicAnalysis(data);
          })
          .catch(function(err) {
            loading.style.display = 'none';
            content.innerHTML = '<p class="analysis-empty">Analysis failed. Please try again.</p>';
          });

        // Also load search results
        loadSearchResults(query);

        // Update page title
        var title = document.querySelector('.page-title');
        if (title) title.textContent = 'Search: "' + query + '"';
      });
    })();
  </script>
  <script>
    // Topic Analysis Function
    function analyzeTopic(event, encodedQuery) {
      event.preventDefault();
      var query = decodeURIComponent(encodedQuery);

      var panel = document.getElementById('topic-analysis');
      var loading = panel.querySelector('.analysis-loading');
      var content = panel.querySelector('.analysis-content');

      // Show panel with loading state
      panel.style.display = 'block';
      loading.style.display = 'flex';
      content.innerHTML = '';

      // Update URL
      var newUrl = '/?q=' + encodedQuery;
      window.history.pushState({}, '', newUrl);

      // Mark the clicked topic as active
      document.querySelectorAll('.trending-item').forEach(function(item) {
        item.classList.remove('active');
        if (item.dataset.topic === query) {
          item.classList.add('active');
        }
      });

      // Fetch analysis
      fetch('/search/analyze_topic?q=' + encodedQuery)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          loading.style.display = 'none';
          content.innerHTML = renderTopicAnalysis(data);
        })
        .catch(function(err) {
          loading.style.display = 'none';
          content.innerHTML = '<p class="analysis-empty">Analysis failed. Please try again.</p>';
        });

      // Also reload the page content with search results
      loadSearchResults(query);
    }

    function loadSearchResults(query) {
      var container = document.getElementById('entries-container');
      var encodedQuery = encodeURIComponent(query);
      fetch('/?q=' + encodedQuery + '&partial=1', { headers: { 'Accept': 'text/html' } })
        .then(function(r) { return r.text(); })
        .then(function(html) {
          container.innerHTML = html;
          // Update page header
          var title = document.querySelector('.page-title');
          if (title) title.textContent = 'Search: "' + query + '"';
        });
    }

    function renderTopicAnalysis(data) {
      if (data.error) {
        return '<p class="analysis-empty">' + data.error + '</p>';
      }

      if (data.message) {
        return '<div class="analysis-header"><div class="analysis-icon">AI</div><span class="analysis-title">Topic Summary</span><button class="analysis-close" onclick="closeAnalysis()">&times;</button></div><p class="analysis-empty">' + data.message + ' (' + data.article_count + ' articles found)</p>';
      }

      var html = '<div class="analysis-header"><div class="analysis-icon">AI</div><span class="analysis-title">' + escapeHtml(data.topic) + ' — Summary</span><button class="analysis-close" onclick="closeAnalysis()">&times;</button></div>';

      // Summary
      if (data.summary) {
        html += '<p class="analysis-summary">' + escapeHtml(data.summary) + '</p>';
      }

      // Key Takeaways
      if (data.takeaways && data.takeaways.length > 0) {
        html += '<div class="analysis-section"><div class="analysis-section-title">Key Takeaways</div><ul class="takeaways-list">';
        data.takeaways.forEach(function(takeaway) {
          html += '<li>' + escapeHtml(takeaway) + '</li>';
        });
        html += '</ul></div>';
      }

      // Key Articles to Read
      if (data.key_articles && data.key_articles.length > 0) {
        html += '<div class="analysis-section"><div class="analysis-section-title">Key Articles</div><div class="key-articles">';
        data.key_articles.forEach(function(article) {
          html += '<a href="' + escapeHtml(article.url) + '" target="_blank" class="key-article-link">';
          html += '<span class="key-article-title">' + escapeHtml(article.title) + '</span>';
          html += '<span class="key-article-source">' + escapeHtml(article.source) + '</span>';
          html += '</a>';
        });
        html += '</div></div>';
      }

      html += '<p class="analysis-meta">Based on ' + data.article_count + ' articles</p>';

      return html;
    }

    function closeAnalysis() {
      var panel = document.getElementById('topic-analysis');
      panel.style.display = 'none';
    }

    function toggleCategories() {
      var nav = document.getElementById('categories-nav');
      nav.classList.toggle('expanded');
    }

    function selectCategory(category) {
      if (category) {
        analyzeCategory({ preventDefault: function(){}, stopPropagation: function(){} }, encodeURIComponent(category));
      } else {
        closeAnalysis();
        window.location.href = '/';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Article Summary Function
    function summarizeArticle(event, entryId) {
      event.preventDefault();
      event.stopPropagation();

      var modal = document.getElementById('article-summary-modal');
      var titleEl = document.getElementById('summary-title');
      var contentEl = document.getElementById('summary-content');

      // Show modal with loading state
      modal.classList.add('open');
      titleEl.textContent = 'Loading...';
      contentEl.innerHTML = '<div class="analysis-loading" style="justify-content: center;"><div class="spinner"></div><span>Analyzing article...</span></div>';

      fetch('/search/summarize_article/' + entryId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.error) {
            contentEl.innerHTML = '<p class="analysis-empty">' + escapeHtml(data.error) + '</p>';
            return;
          }

          titleEl.textContent = data.title;

          var html = '';
          if (data.tldr) {
            html += '<div class="article-summary-tldr">' + escapeHtml(data.tldr) + '</div>';
          }

          if (data.insights && data.insights.length > 0) {
            html += '<div class="article-summary-insights"><h4>Key Insights</h4><ul>';
            data.insights.forEach(function(insight) {
              html += '<li>' + escapeHtml(insight) + '</li>';
            });
            html += '</ul></div>';
          }

          if (data.reading_time) {
            html += '<p class="analysis-meta">' + data.reading_time + ' min read</p>';
          }

          contentEl.innerHTML = html;
        })
        .catch(function(err) {
          contentEl.innerHTML = '<p class="analysis-empty">Failed to analyze article.</p>';
        });
    }

    function closeSummaryModal() {
      var modal = document.getElementById('article-summary-modal');
      modal.classList.remove('open');
    }

    // Close modal on overlay click
    document.getElementById('article-summary-modal').addEventListener('click', function(e) {
      if (e.target === this) closeSummaryModal();
    });

    // Category Analysis Function
    function analyzeCategory(event, encodedCategory) {
      event.preventDefault();
      var category = decodeURIComponent(encodedCategory);

      var panel = document.getElementById('topic-analysis');
      var loading = panel.querySelector('.analysis-loading');
      var content = panel.querySelector('.analysis-content');

      // Show panel with loading state
      panel.style.display = 'block';
      loading.style.display = 'flex';
      content.innerHTML = '';

      // Update URL
      var newUrl = '/?category=' + encodedCategory;
      window.history.pushState({}, '', newUrl);

      // Mark the clicked category as active
      document.querySelectorAll('.category-pill').forEach(function(pill) {
        pill.classList.remove('active');
        if (pill.dataset.category === category) {
          pill.classList.add('active');
        }
      });

      // Fetch analysis
      fetch('/search/analyze_topic?category=' + encodedCategory)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          loading.style.display = 'none';
          content.innerHTML = renderTopicAnalysis(data);
        })
        .catch(function(err) {
          loading.style.display = 'none';
          content.innerHTML = '<p class="analysis-empty">Analysis failed. Please try again.</p>';
        });

      // Also reload the page content with category results
      loadCategoryResults(category);
    }

    function loadCategoryResults(category) {
      var container = document.getElementById('entries-container');
      var encodedCategory = encodeURIComponent(category);
      fetch('/?category=' + encodedCategory + '&partial=1', { headers: { 'Accept': 'text/html' } })
        .then(function(r) { return r.text(); })
        .then(function(html) {
          container.innerHTML = html;
          // Update page header
          var title = document.querySelector('.page-title');
          if (title) title.textContent = category;
        });
    }
  </script>

  <div class="search-layout">
    <%= render "trending_sidebar" %>
    <main class="main search-main">
    <div class="page-header">
      <% if @query.present? %>
        <h1 class="page-title">Search: "<%= @query %>"</h1>
      <% elsif @category.present? %>
        <h1 class="page-title"><%= @category %></h1>
      <% else %>
        <h1 class="page-title">All Articles</h1>
      <% end %>
      <p class="page-subtitle"><%= @total_count %> articles</p>
    </div>

    <!-- Desktop categories -->
    <nav class="categories categories-desktop" id="categories-nav">
      <a href="/" class="category-pill" onclick="closeAnalysis()">← All</a>
      <% %w[AI/ML Programming Security DevOps Web Gaming Business Science Design Culture News Tutorial].each_with_index do |cat, i| %>
        <a href="#" class="category-pill <%= 'active' if @category == cat %> <%= 'category-hidden' if i >= 7 %>" data-category="<%= cat %>" onclick="analyzeCategory(event, '<%= CGI.escape(cat) %>')"><%= cat %></a>
      <% end %>
      <button type="button" class="category-pill category-more" id="show-more-cats" onclick="toggleCategories()">More +</button>
    </nav>

    <!-- Mobile category dropdown -->
    <div class="categories-mobile">
      <select class="category-select" onchange="selectCategory(this.value)">
        <option value="">All Categories</option>
        <% %w[AI/ML Programming Security DevOps Web Gaming Business Science Design Culture News Tutorial].each do |cat| %>
          <option value="<%= cat %>" <%= 'selected' if @category == cat %>><%= cat %></option>
        <% end %>
      </select>
    </div>

    <div id="ai-response" class="ai-response">
      <div class="ai-response-header">
        <div class="ai-response-icon">AI</div>
        <span class="ai-response-label">Feed Assistant</span>
        <button type="button" class="ai-response-close" id="ai-close">&times;</button>
      </div>
      <div class="ai-response-text" id="ai-answer"></div>
      <div class="ai-response-sources" id="ai-sources" style="display:none;">
        <div class="ai-response-sources-title">Sources</div>
        <div id="ai-sources-list"></div>
      </div>
    </div>

    <div id="topic-analysis" class="topic-analysis-panel" style="display: none;">
      <div class="analysis-loading">
        <div class="spinner"></div>
        <span>Analyzing coverage...</span>
      </div>
      <div class="analysis-content"></div>
    </div>

    <div id="entries-container">
      <% if @entries.any? %>
        <%= render "entries_grouped" %>
      <% else %>
        <div class="empty-state">
          <h2>No articles found</h2>
          <p>Try a different search or browse by category</p>
        </div>
      <% end %>
    </div>

    <% if @entries.any? && @entries.total_pages > 1 %>
      <div id="infinite-sentinel" class="infinite-sentinel" data-page="<%= @page %>" data-total-pages="<%= @entries.total_pages %>" data-query="<%= @query %>" data-category="<%= @category %>" data-feed-id="<%= @feed_id %>">
        Scroll for more
      </div>
    <% end %>
  </main>
  <script>
    (function() {
      var sentinel = document.getElementById('infinite-sentinel');
      if (!sentinel) return;
      var container = document.getElementById('entries-container');
      var currentPage = parseInt(sentinel.dataset.page, 10);
      var totalPages = parseInt(sentinel.dataset.totalPages, 10);
      function buildUrl(page) {
        var params = new URLSearchParams();
        params.set('page', page);
        params.set('partial', '1');
        if (sentinel.dataset.query) params.set('q', sentinel.dataset.query);
        if (sentinel.dataset.category) params.set('category', sentinel.dataset.category);
        if (sentinel.dataset.feedId) params.set('feed_id', sentinel.dataset.feedId);
        return '/?' + params.toString();
      }
      var observer = new IntersectionObserver(function(entries) {
        if (!entries[0].isIntersecting) return;
        if (currentPage >= totalPages) { sentinel.classList.add('done'); sentinel.textContent = ''; return; }
        sentinel.classList.add('loading');
        sentinel.textContent = 'Loading...';
        var nextPage = currentPage + 1;
        fetch(buildUrl(nextPage), { headers: { 'Accept': 'text/html' } })
          .then(function(r) { return r.text(); })
          .then(function(html) {
            var wrap = document.createElement('div');
            wrap.innerHTML = html;
            while (wrap.firstChild) container.appendChild(wrap.firstChild);
            currentPage = nextPage;
            sentinel.dataset.page = currentPage;
            sentinel.classList.remove('loading');
            sentinel.textContent = currentPage >= totalPages ? '' : 'Scroll for more';
            if (currentPage >= totalPages) sentinel.classList.add('done');
          })
          .catch(function() {
            sentinel.classList.remove('loading');
            sentinel.textContent = 'Load more';
          });
      }, { rootMargin: '200px' });
      observer.observe(sentinel);
    })();
  </script>
  </div>
</body>
</html>
