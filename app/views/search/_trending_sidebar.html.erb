<aside class="trending-sidebar">
  <% if @crawl_timing %>
  <div class="crawl-timing">
    <div class="timing-item">
      <span class="timing-label">Updated</span>
      <span class="timing-value"><%= @crawl_timing[:last_updated] ? time_ago_in_words(@crawl_timing[:last_updated]) + " ago" : "â€”" %></span>
    </div>
    <div class="timing-item">
      <span class="timing-label">Next</span>
      <span class="timing-value"><%= @crawl_timing[:next_update_in] > 60 ? "#{(@crawl_timing[:next_update_in] / 60).round} min" : "soon" %></span>
    </div>
  </div>
  <% end %>
  <div class="trending-sidebar-title">Trending This Week</div>
  <nav class="trending-nav">
    <% if @trending_topics.present? %>
      <% @trending_topics.each do |topic| %>
        <% search_query = topic[:keywords]&.first || topic[:name] %>
        <a href="#" class="trending-item <%= 'active' if @query == search_query %>" data-topic="<%= search_query %>" onclick="analyzeTopic(event, '<%= CGI.escape(search_query) %>')">
          <span class="trending-emoji"><%= topic[:emoji] %></span>
          <div class="trending-content">
            <div class="trending-name"><%= topic[:name] %></div>
            <div class="trending-meta">
              <span class="trending-count"><%= topic[:total] %> articles</span>
              <span class="trending-sparkline">
                <%
                  data = topic[:sparkline] || []
                  unless data.blank? || data.all?(&:zero?)
                    width = 50
                    height = 14
                    max_val = [data.max, 1].max
                    points = data.each_with_index.map do |val, i|
                      x = (i.to_f / [data.size - 1, 1].max) * width
                      y = height - ((val.to_f / max_val) * (height - 2)) - 1
                      "#{x.round(1)},#{y.round(1)}"
                    end.join(" ")
                %>
                <svg viewBox="0 0 <%= width %> <%= height %>">
                  <polyline fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" points="<%= points %>"/>
                </svg>
                <% end %>
              </span>
            </div>
          </div>
          <% if topic[:trend] == "rising" %>
            <span class="trending-badge rising">Hot</span>
          <% end %>
        </a>
      <% end %>
    <% else %>
      <div class="trending-empty">Analyzing trends...</div>
    <% end %>
  </nav>

  <div class="trending-divider"></div>

  <div class="trending-sidebar-title">Sources</div>
  <nav class="sources-nav">
    <a href="<%= @query.present? ? "/?q=#{CGI.escape(@query)}" : "/" %>" class="source-item <%= 'active' unless @feed_id %>">
      <span class="source-name">All Sources</span>
    </a>
    <% @sources.first(10).each do |source| %>
      <a href="<%= @query.present? ? "/?q=#{CGI.escape(@query)}&feed_id=#{source.id}" : "/?feed_id=#{source.id}" %>" class="source-item <%= 'active' if @feed_id.to_s == source.id.to_s %>">
        <span class="source-name"><%= source.title %></span>
        <span class="source-count"><%= source.entries_count %></span>
      </a>
    <% end %>
  </nav>
</aside>
